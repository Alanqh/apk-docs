## CP对接233平台交易时序图【重客户端】：

![img](https://arkimg.ark.online/(null)-20240520175744472.png)

## 前言：

- 在233平台游戏道具充值购买场景
  - 1. 涉及对接方：游戏开发商（CP）、233游戏平台、第三方支付平台（微信支付、支付宝等）；
  - 2. 涉及业务对接节点： 游戏开发商游戏程序、233平台交易SDK、游戏开发商服务器端、233服务器端、第三方支付平台；
  - 3. CP在233平台下单的订单号必须要保证在CP交易系统中唯一性（与其他CP无关），如果重复，会对后续订单查询等接口造成不可逆影响，平台与CP也无法根据订单明细进行对账；
  - 4. 233平台在新版本发货（V2）版本接口中新增了平台唯一性订单交易编号（tradeNo），推荐CP对接发货功能对接到V2的流程中；平台的tradeNo是具备唯一性；
  - 5. CP在确认收到发货接口回调时（流程图第8步）建议回查233平台订单交易状态（接入**参考文档**）
  - 6. CP需要自己保证发货接口的**幂等性**，233平台**不保证同一笔订单发货接口只调用1次**，且**可能存在并发回调**；
  - 7. CP推荐在确认发货成功后再给出约定的已发货响应值，如果处理是失败，233平台还会重试多次发货回调；
  - 8. **CP接收回调后，推荐根据tradeNo查询233平台交易结果，并判断**  **订单原值金额 = CP本地订单金额；****如金额不一致，可认为是受到攻击；如CP仍然发货，233平台与CP结算将以实际订单收款数据做结算，产生损失将由CP自行承担；****优惠券抵扣金额**推荐不做是否发货逻辑判断，可用作财务结算对账使用**；**

## 回调接口协议：

- 协议摘要描述：
  - 采用Https接口调用协议；数据安全采用**加密或加密验签**方式做身份认证；
  - 秘钥：对接CP涉及秘钥身份标识统一在233开发者平台申请获取；
- 接口安全对接种类：（未来可在233开发者平台申请配置不同的安全种类）
  - **SHA1 接口参数验签**
    - 签名规则
      - 参数大小写敏感（区分大小写）；
      - 多参数拼接采用 & 符号作为分隔符；
      - 参数的value为null或者是空字符串【""】是不参与签名，签名的参数（sign）也不参与签名；
      - 参数签名顺序是按照参数名的ASCII码从小到大排序；
      - 所有业务参数顺序拼接完成后，再在最后拼接cp秘钥参数，参数名为:**secret**；
      - 签名值：**将签名参数拼接完成后的字符串进行SHA1加密，截取后32位字符，并转换为大写；**
      - 在原有参数列表中增加签名参数 sign ，与普通参数平级；
    - 举例：
      - 参数原始数据有：{"orderId" : "202001101301002" , "productName" : "pizza" , "year" : 2020 ,  "desc" : "" , "sort" :  107}
      - cp在233平台秘钥为: 4D2CD76B80C40B3B4EAE2E04BACA46B8
      - 签名字符串为:  orderId=202001101301002&productName=pizza&sort=107&year=2020&secret=4D2CD76B80C40B3B4EAE2E04BACA46B8
      - 签名值：9AD9B18B1E0E59287AB8E5E3E414D072
      - 在参数体内再额外增加签名的值，提交的参数即为{"orderId" : "202001101301002" , "productName" : "pizza" , "year" : 2020 ,  "desc" : "" , "sort" :  107, "sign" : "9AD9B18B1E0E59287AB8E5E3E414D072" }

注：在所有CP提供的被233访问的接口（例如订单支付完成通知接口）中，采用SHA1的验签方式时，都会在原有的业务数据结构体中增加一个 属性名: sign 值为String 的签名数据字段；

## 对接业务：

##### 交易订单收款通知【通知CP发货，对接时序图第7步】

### V2版本【**推荐使用**】

- 
  - 接口地址：由CP在233开发者平台**配置发货地址** 和 **选择接入版本**【V2】 Content-Type: APPLICATION/JSON 默认接口安全类型： SHA1 接口参数验签

```Bash
{
"tradeNo"           :   String,
"cpOrderId"         :   String,
"productCode"       :   String,
"productName"       :   String,
"productPrice"      :   unsigned int,
"count"             :   unsigned int,
"nonce"             :   String,
"amount"            :   unsigned int,
"couponDeductAmount":   unsigned int,
"extra"             :   String,
"sign"              :   String
}
 
数据项解释：
-tradeNo               @NotNull    233平台对应的交易订单编号（具备唯一性）
-cpOrderId             @NotNull    供应商交易订单id（由供应商下单后出传入）
-productCode           @NotNull    商品编号（供应商下单时提供）
-productName           @NotNull    商品名称（供应商下单时提供）
-productPrice          @NotNull    商品单价（单位：分【人民币分】）
-count                 @NotNull    订单购买购买数量
-nonce                 @NotNull    随机安全码（无业务意义，增加接口安全随机性）
-amount                @NotNull    订单原值金额（单位：分【人民币】）
-couponDeductAmount    @Nullable   优惠券抵扣金额（因优惠券而优惠的金额）（单位：分【人民币】），当该笔交易未使用优惠券时，值为0
-extra                 @Nullable   由供应商预下单时传入扩展透传参数，原封不动给到供应商系统，当CP交易系统下单未提供扩展字段时，该字段为空
-sign                  　　　　　　  当接口安全为SHA1参数验签时，为必填参数(@NotNull），参数签名的值； 
***注意***      在233平台即将推出多种加密协议选取方式（由CP在233开发者平台选择），会多出对应协议的字段；例如："SHA1的验签方式" 会额外增加sign字段；推荐CP对接技术选择动态解析参数，并做动态计算验签等方式；
```

Http响应：（HTTP状态码必须为200，**Content-Type: APPLICATION/JSON**）

```Bash
{
"code"      :   int,
"message"   :   String
}
数据项解释:
-code      @NotNull    响应状态码，200:发货处理成功；22100 : 数据签名不正确；22101:接口参数验证不同过； 22102:CP无法发货（例如因为无库存、商品下架等原因，明确指出该笔订单无法履约【233平台会立刻给用户退款，并取消该笔订单】）;其它标识失败；
-message   @Nullable   业务码解释；【方便技术对接信息】
```

发货响应状态码详述【建议CP对接接口都要给出明确的接口处理状态码】

| 状态码 | 业务含义                                                     | 是否认为CP发货业务处理完成 （是:233不会再重试发货接口调用，否：233依然会再多次请求尝试发货请求） |
| ------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 22100  | 数据签名不正确                                               | 否                                                           |
| 22101  | 接口参数验证不同过                                           | 否                                                           |
| 22103  | 未知业务错误（CP运行时未知错误异常）                         | 否                                                           |
| 200    | 业务处理成功                                                 | 是                                                           |
| 22102  | CP无法发货（例如因为无库存、商品下架等原因，明确指出该笔订单无法履约【233平台会立刻给用户退款，并取消该笔订单】）; | 是【并会立即退款给用户】                                     |

#### V1版本【不推荐使用】【该数据结构中涉及字段不清晰以及缺失唯一性交易编号】

- **Content-Type: APPLICATION/JSON**
- **默认接口安全类型： SHA1 接口参数验签**

```Bash
{
"resultCode"        :   String,
"resultDesc"        :   String,
"orderId"           :   String,
"orderAmount"       :   unsigned int,
"orderProductCode"  :   String,
"voucherAmount"     :   unsigned int,
"voucherType"       :   int,
"voucherId"         :   String,
"cpExtra"           :   String,
}
 
 数据项解释：
- resultCode        @NotNull        订单交易结果编码； "SUCCESS" ，常量， SUCCESS 标识订单付款完成；
- resultDesc        @NotNull        订单结果描述，"OK"；常量；
- orderId           @NotNull        CP交易系统订单编号（由CP方订单系统产生的唯一性订单编号），CP应保证在其系统中的唯一性，订单编号不能重复，如果重复，会对后续订单查询等接口造成不可逆影响，平台与CP也无法根据订单明细进行对账；
- orderAmount       @NotNull        订单实际支付金额，（单位：分【人民币】）
- orderProductCode  @NotNull        商品编号（供应商下单时提供）
- voucherAmount     @NotNull        优惠券抵扣金额（因优惠券而优惠的金额），（单位：分【人民币】），当优惠券金额 &gt; 0时，标识该笔交易使用了优惠券优惠了的金额，为0时标识并未使用优惠券；
- voucherType       @NotNull        代金券类型（接入方可忽略该字段类型解释），当未使用优惠券时，会有默认值0；
- voucherId         @Nullable       当该笔交易使用优惠券时，才会有值，
- cpExtra           @Nullable       由供应商预下单时传入扩展透传参数，原封不动给到供应商系统，当CP交易系统下单未提供扩展字段时，该字段为空
```

​        响应数据结构：(HTTP 状态码必须为200，**Content-Type: APPLICATION/JSON**)

​        **CP 需要给出准确的如下响应内容233平台才认为CP发货成功，否则还会继续重试发货回调；**

```Bash
{
"code"      :   int,
"cpRewarded":   int
}
 
数据项解释:【当CP返回明确响应内容体后，233平台会将订单流程处理完成，不会再进行发货接口回调，请接入方确认货物已经发送成功了，再给出准确的响应内容，发货流程响应CP自己处理幂等性（针对该笔订单）】
-code          @NotNull    响应状态码，200:对接成功，其它标识失败；
-cpRewarded    @NotNull    发货业务码; 1 : CP成功发货； 0:CP无法发货（例如因为无库存、商品下架等原因，明确指出该笔订单无法履约【233平台会立刻给用户退款，并取消该笔订单】）；
```